<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Solana Pay - Helmet Sanitizer</title>
    <style>
        /* Keep all your existing CSS styles */
        /* ... existing CSS ... */
        
        .transaction-input {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 12px 15px;
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        
        .transaction-input:focus {
            outline: none;
            border-color: #14F195;
            box-shadow: 0 0 15px rgba(20, 241, 149, 0.3);
        }
        
        .transaction-submit {
            background: linear-gradient(135deg, #9945FF 0%, #14F195 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
            width: 100%;
        }
        
        .transaction-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(153, 69, 255, 0.4);
        }
        
        .manual-verification {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
    </style>
    <!-- Add Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
</head>
<body>
    <div class="particles" id="particles"></div>
    <a href="/" class="back-button">‚Üê</a>

    <div class="container">
        <div class="header">
            <div class="logo-container">
                <div class="logo">üü£</div>
                <div>
                    <h1>Solana Pay</h1>
                    <p class="subtitle">Fast & Decentralized</p>
                </div>
            </div>
        </div>

        <div class="solana-display">
            <div id="paymentArea">
                <div class="qr-section">
                    <div class="loader"></div>
                    <p class="status-text">Generating Solana Pay QR...</p>
                </div>
            </div>

            <div class="progress-steps">
                <div class="step active">1</div>
                <div class="step">2</div>
                <div class="step">3</div>
            </div>

            <!-- Manual Transaction Verification -->
            <div class="manual-verification">
                <h3 style="margin-bottom: 10px; color: #9945FF;">üîç Manual Verification</h3>
                <p style="font-size: 0.85em; opacity: 0.8; margin-bottom: 10px;">
                    Already made a payment? Paste your transaction signature:
                </p>
                <input type="text" 
                       id="txSignature" 
                       class="transaction-input" 
                       placeholder="Enter transaction signature..."
                       style="font-size: 0.8em;">
                <button onclick="submitTransaction()" 
                        class="transaction-submit" 
                        id="verifyBtn">
                    ‚úÖ Verify Transaction
                </button>
            </div>

            <div class="instructions">
                <h3>üì± How to Pay with Solana:</h3>
                <ol>
                    <li>Open Phantom, Solflare, or any Solana wallet</li>
                    <li>Scan the QR code above</li>
                    <li>Confirm the transaction</li>
                    <li>Wait for sanitization to complete</li>
                </ol>
            </div>

            <div class="controls">
                <button class="btn btn-simulate" id="simulateBtn" onclick="simulatePayment()">
                    ‚ö° Simulate Payment (Testing)
                </button>
            </div>
        </div>
    </div>

    <div class="sanitizing-animation" id="sanitizingAnimation">
        <div class="sanitizing-icon">üßº</div>
        <div class="sanitizing-text">Sanitizing Helmet...</div>
        <div class="sanitizing-progress">
            <div class="sanitizing-progress-bar"></div>
        </div>
        <p style="margin-top: 20px; font-size: 1.1em; opacity: 0.8;">UV-C Sterilization ‚Ä¢ 10 seconds</p>
    </div>

    <script>
        let paymentReference = null;
        let pollInterval = null;
        let solanaConnection = null;

        // Initialize Solana connection
        function initSolana() {
            try {
                // For devnet
                const network = 'devnet';
                const endpoint = 'https://api.devnet.solana.com';
                solanaConnection = new solanaWeb3.Connection(endpoint, 'confirmed');
                console.log('‚úÖ Solana connection initialized');
            } catch (error) {
                console.error('‚ùå Failed to initialize Solana:', error);
            }
        }

        async function initializeSolanaPayment() {
            try {
                const response = await fetch('/create_solana_payment', { method: 'POST' });
                const data = await response.json();

                if (!data.qr_image) {
                    throw new Error('Failed to generate QR');
                }

                paymentReference = data.reference;
                window.currentSolanaAmount = data.amount;

                document.getElementById('paymentArea').innerHTML = `
                    <div class="qr-section">
                        <div class="qr-code-container">
                            <img src="data:image/png;base64,${data.qr_image}" alt="Solana Pay QR">
                        </div>
                        <div class="amount-display">${data.amount}</div>
                        <div class="wallet-address">To: ${data.recipient.substring(0, 20)}...${data.recipient.substring(data.recipient.length - 10)}</div>
                        <p class="status-text">Waiting for payment...</p>
                        <div style="margin-top: 15px;">
                            <a href="${data.solana_url}" target="_blank" style="color: #14F195; text-decoration: underline; font-size: 0.9em;">
                                Open in wallet app
                            </a>
                        </div>
                    </div>
                `;

                // Start polling for payment
                startPolling();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('paymentArea').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4em;">‚ö†Ô∏è</div>
                        <h3 style="margin-top: 15px;">Error</h3>
                        <p style="margin-top: 10px; opacity: 0.8;">Failed to generate payment QR</p>
                        <button onclick="initializeSolanaPayment()" class="btn btn-simulate" style="margin-top: 15px;">
                            üîÑ Try Again
                        </button>
                    </div>
                `;
            }
        }

        function startPolling() {
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/check_solana_payment/${paymentReference}`);
                    const data = await response.json();

                    if (data.status === 'PAID') {
                        clearInterval(pollInterval);
                        onPaymentSuccess();
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 3000);

            // Timeout after 5 minutes
            setTimeout(() => {
                clearInterval(pollInterval);
            }, 300000);
        }

        async function submitTransaction() {
            const signature = document.getElementById('txSignature').value.trim();
            const verifyBtn = document.getElementById('verifyBtn');
            
            if (!signature) {
                alert('Please enter a transaction signature');
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying...';

            try {
                const response = await fetch('/confirm_solana_payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reference: paymentReference,
                        signature: signature
                    })
                });

                const data = await response.json();

                if (data.success) {
                    window.solanaSessionId = data.session_id;
                    onPaymentSuccess();
                } else {
                    alert('Transaction verification failed: ' + (data.error || 'Unknown error'));
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = '‚úÖ Verify Transaction';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error. Please try again.');
                verifyBtn.disabled = false;
                verifyBtn.textContent = '‚úÖ Verify Transaction';
            }
        }

        async function simulatePayment() {
            const btn = document.getElementById('simulateBtn');
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                const response = await fetch('/confirm_solana_payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reference: paymentReference,
                        signature: 'simulated-tx-' + Date.now()
                    })
                });

                const data = await response.json();

                if (data.status === 'PAID') {
                    window.solanaSessionId = data.session_id;
                    onPaymentSuccess();
                }
            } catch (error) {
                console.error('Error:', error);
                btn.disabled = false;
                btn.textContent = '‚ö° Try Again';
            }
        }

        function onPaymentSuccess() {
            const steps = document.querySelectorAll('.step');
            steps[0].classList.add('completed');
            steps[1].classList.add('active');

            document.getElementById('paymentArea').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 6em; color: #14F195; filter: drop-shadow(0 0 20px rgba(20, 241, 149, 0.6));">‚úÖ</div>
                    <h2 style="margin-top: 20px; color: #14F195;">Payment Confirmed!</h2>
                    <p style="margin-top: 10px; opacity: 0.9;">Transaction verified on Solana</p>
                </div>
            `;

            setTimeout(() => {
                steps[1].classList.add('completed');
                steps[2].classList.add('active');
                startSanitization();
            }, 2000);
        }

        function startSanitization() {
            document.getElementById('sanitizingAnimation').classList.add('active');
            setTimeout(() => completeSanitization(), 10000);
        }

        function completeSanitization() {
            const sanitizingAnimation = document.getElementById('sanitizingAnimation');
            
            sanitizingAnimation.innerHTML = `
                <div class="sanitizing-icon" style="animation: none; font-size: 8em;">‚ú®</div>
                <div class="sanitizing-text" style="color: #14F195;">Sanitization Complete</div>
                <p style="margin-top: 20px; font-size: 1.2em; font-weight: 600;">Your helmet is clean & safe</p>
                <p style="margin-top: 15px; font-size: 0.95em; opacity: 0.8;">99.9% bacteria eliminated</p>
                <p style="margin-top: 25px; font-size: 1.1em;">Have a safe ride! üèçÔ∏è</p>
            `;

            setTimeout(() => {
                const sessionId = window.solanaSessionId;
                if (sessionId) {
                    window.location.href = `/rating/${sessionId}`;
                } else {
                    window.location.href = '/';
                }
            }, 3000);
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initSolana();
            initializeSolanaPayment();
        });

        // Auto-reset
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                clearInterval(pollInterval);
                window.location.href = '/';
            }, 120000);
        }

        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('touchstart', resetInactivityTimer);
        resetInactivityTimer();
    </script>
</body>
</html>